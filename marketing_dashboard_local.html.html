<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Innovator ETFs Marketing Dashboard (Dropbox)</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- FullCalendar CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css"
  />
  <style>
    body {
      background-color: #f5f6fa;
      color: #333;
      font-family: Arial, sans-serif;
    }
    h2 {
      font-weight: 600;
      color: #002d38;
    }
    .sidebar {
      height: 100vh;
      overflow-y: auto;
      padding: 20px;
      background-color: #002d38;
      color: #fff;
    }
    .activation-card {
      margin-bottom: 1rem;
      border: none;
    }
    .activation-card .card-header {
      background-color: #003f4c;
      color: #fff;
      cursor: pointer;
      padding: 0.5rem 1rem;
    }
    .activation-card .card-header .form-check-input {
      margin-right: 0.5rem;
    }
    .activation-card .card-body {
      padding: 0;
      background-color: #002d38;
    }
    .activation-card .list-group-item {
      background-color: transparent;
      border: none;
      color: #d0e4ec;
      padding: 0.25rem 1rem;
    }
    .activation-card .list-group-item:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .main-content {
      padding: 20px;
    }
    .calendar-container {
      max-width: 100%;
    }
    .color-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <nav class="col-md-3 sidebar">
        <h2 class="mb-4">Activations</h2>
        <div id="activation-sections"></div>
      </nav>
      <main class="col-md-9 main-content">
        <h2 class="mb-3">Innovator ETFs Marketing Calendar</h2>
        <div id="summary" class="alert alert-info d-none"></div>
        <div id="calendar" class="calendar-container"></div>
      </main>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Colors for categories
    const COLORS = [
      '#5D737E','#64B6AC','#C0D6DF','#C7B198',
      '#A26769','#6B4226','#B2B1B9','#A99985',
      '#77966D','#858ae3','#8e806a','#e9d5ca'
    ];
    let colorMap = {};
    let globalEvents = [];
    let calendar;
    let selectedCategories = new Set();

    function initCalendar() {
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek'
        },
        height: 'auto',
        events: [],
        eventDidMount: info => {
          const description = info.event.extendedProps.description;
          if (description) {
            info.el.setAttribute('title', description);
          }
        }
      });
      calendar.render();
    }

    function renderCalendarEvents() {
      calendar.getEvents().forEach(e => e.remove());
      const filtered = globalEvents.filter(evt => selectedCategories.size === 0 || selectedCategories.has(evt.title));
      filtered.forEach(evt => calendar.addEvent(evt));
    }

    function buildActivationSections(data) {
      const container = document.getElementById('activation-sections');
      container.innerHTML = '';
      const groups = {};
      data.forEach(row => {
        const cat = row['Item']?.toString().trim();
        const dateStr = row['Date'];
        if (!cat || !dateStr) return;
        if (!groups[cat]) groups[cat] = [];
        const date = new Date(dateStr);
        const desc = row['Description']?.toString().trim() || '';
        groups[cat].push({ date, desc });
      });
      const categories = Object.keys(groups).sort();
      let colorIndex = 0;
      categories.forEach(cat => {
        if (!colorMap[cat]) {
          colorMap[cat] = COLORS[colorIndex % COLORS.length];
          colorIndex++;
        }
        groups[cat].sort((a,b) => a.date - b.date);
        const eventsInCat = groups[cat];
        const sanitizedId = cat.replace(/[^a-zA-Z0-9]/g, '');
        const card = document.createElement('div');
        card.className = 'card activation-card';
        const header = document.createElement('div');
        header.className = 'card-header d-flex align-items-center';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input me-2';
        checkbox.dataset.category = cat;
        checkbox.addEventListener('change', function() {
          if (this.checked) selectedCategories.add(cat); else selectedCategories.delete(cat);
          renderCalendarEvents();
        });
        header.appendChild(checkbox);
        const dot = document.createElement('span');
        dot.className = 'color-dot';
        dot.style.backgroundColor = colorMap[cat];
        header.appendChild(dot);
        const title = document.createElement('h5');
        title.className = 'mb-0';
        title.textContent = cat;
        header.appendChild(title);
        card.appendChild(header);
        const collapse = document.createElement('div');
        collapse.className = 'card-body collapse';
        collapse.id = sanitizedId;
        const list = document.createElement('ul');
        list.className = 'list-group list-group-flush';
        eventsInCat.forEach(ev => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-start';
          li.textContent = ev.date.toLocaleDateString('en-US') + ': ' + ev.desc;
          list.appendChild(li);
        });
        collapse.appendChild(list);
        header.addEventListener('click', () => {
          const current = document.getElementById(sanitizedId);
          if (current.classList.contains('show')) current.classList.remove('show'); else current.classList.add('show');
        });
        card.appendChild(collapse);
        container.appendChild(card);
      });
    }

    function buildCalendarEvents(data) {
      globalEvents = [];
      data.forEach(row => {
        const dateStr = row['Date'];
        const title = row['Item']?.toString().trim();
        const desc = row['Description']?.toString().trim() || '';
        if (!dateStr || !title) return;
        const d = new Date(dateStr);
        if (isNaN(d)) return;
        globalEvents.push({
          title,
          start: d,
          color: colorMap[title] || '#4285F4',
          description: desc
        });
      });
      renderCalendarEvents();
    }

    function loadFromXlsx(url) {
      fetch(url)
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.arrayBuffer();
        })
        .then(arrayBuffer => {
          const workbook = XLSX.read(arrayBuffer, { type: 'array' });
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const data = XLSX.utils.sheet_to_json(worksheet, { raw: false }).map(row => {
            if (row['Date'] && typeof row['Date'] === 'string' && row['Date'].includes(',')) {
              // Attempt to parse comma-separated date (e.g., "Tue, Mar 11")
              const parsed = new Date(row['Date']);
              if (!isNaN(parsed)) row['Date'] = parsed;
            }
            return row;
          });
          buildActivationSections(data);
          buildCalendarEvents(data);
          document.querySelectorAll('.activation-card input[type="checkbox"]').forEach(cb => cb.checked = false);
        })
        .catch(err => {
          console.error('Error loading remote file:', err);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initCalendar();
      // Dropbox direct-download URL. Replace this if your share link changes.
      const remoteUrl = 'https://dl.dropboxusercontent.com/scl/fi/i7675nhsdlsm93mr1erpb/Marketing-Tracker.xlsx?rlkey=wdxojebxxttpmi9c4qy18h8i3&st=5jj9hmb0&dl=1';
      loadFromXlsx(remoteUrl);
    });
  </script>
</body>
</html>